<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
</head>
<body style="flex-direction: column;">
    <textarea id="result1" style="width: 100%; height: 100px;"></textarea>
    <textarea id="result2" style="width: 100%; height: 100px;"></textarea>
    <script type="module">
        import { Controller } from './Controller/Controller.js';
        import { ControllerAi } from './Controller/ControllerAi.js';
        import { Canva } from './Model/Canva.js';

        const results = [];
        const result1 = document.getElementById('result1');
        const result2 = document.getElementById('result2');

        async function initializeCanvases() {
            const promises = [];
            const data = await loadData();

            for (let i = 0; i < 20; i++) {
                const canvas = document.createElement('canvas');
                canvas.id = `my_canvas_${i}`;
                canvas.width = Canva.WIDTH;
                canvas.height = Canva.HEIGHT;
                canvas.style.margin = '10px';
                document.body.appendChild(canvas);

                if(i === 0){
                    promises.push(initializeCanvas(canvas, data[i]));
                }

                promises.push(initializeCanvas(canvas));
            }

            const results = await Promise.all(promises); // Exécuter toutes les instances en parallèle
            results.sort((a, b) => b.score - a.score);
            let reproductions = reproduction(results);
            toJSon(results);
            toJSon(reproductions);
        }

        async function initializeCanvas(canvas, data = null) {
            const HEXTILES_IMAGE = new Image();
            HEXTILES_IMAGE.src = 'assets/game-tiles.png';

            await new Promise((resolve) => {
                HEXTILES_IMAGE.addEventListener('load', () => {
                resolve();
                });
            });

            const app = new Controller(HEXTILES_IMAGE, canvas.id, true, data);
            const result = await app.update(); // Attendre que le jeu se termine
            results.push(result);
            return result; // Retourner le résultat
        }

        async function loadData() {
            const response = await fetch("./data.json");
            return await response.json();
        }

        function toJSon(json) {
            const jsonResults = JSON.stringify(json, null, 2);
            const blob = new Blob([jsonResults], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'result.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function reproduction(results) {
            const topResults = results.slice(0, 20);
            const newMatrices = [];
            
            for (let i = 0; i < topResults.length; i++) {
                for (let j = i + 1; j < 5; j++) {
                    const parent1 = topResults[i];
                    const parent2 = topResults[j];

                    const newMatrix = {
                        matrix1: averageMatrices(parent1.matrix1, parent2.matrix1),
                        matrix2: averageMatrices(parent1.matrix2, parent2.matrix2),
                        bais: parent1.bais,
                    };

                    newMatrices.push(newMatrix);
                    if (newMatrices.length >= 10) break;
                }
                if (newMatrices.length >= 10) break;
                return newMatrices;
            }

            function averageMatrices(matrix1, matrix2) {
                return matrix1.map((row, rowIndex) =>
                    row.map((value, colIndex) => (value + matrix2[rowIndex][colIndex]) / 2)
                );
            }

            function averageArray(array1, array2) {
                return array1.map((value, index) => (value + array2[index]) / 2);
            }
        }

        initializeCanvases();
    </script>
</body>
</html>